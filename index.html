<!DOCTYPE html>
<html>
	<head>
		<title>OneSignal CSV Download</title>
		<!-- Add Bootstrap 4 CSS -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
		<script src="https://imlolman.github.io/js/controller.js"></script>
	</head>
	<body>
		<div class="container">
			<h1 class="mt-5">OneSignal CSV Download</h1>
			<p id="message" class="mt-4"></p>

			<form id="credentialsForm" class="mt-4">
				<div class="form-group">
					<label for="appId">App ID</label>
					<input type="text" class="form-control" id="appId" required />
				</div>
				<div class="form-group">
					<label for="apiKey">Rest API Key</label>
					<input type="password" class="form-control" id="apiKey" required />
				</div>
				<button type="submit" class="btn btn-primary">Get CSV</button>
			</form>

			<div id="downloadBtnDiv" class="mt-4" style="display: none">
				<div class="form-group">
					<p>
						<b>On average, the file is generated at a rate of 2,000 records per second.</b><br />The file will be accessible via the URL for 3 days and includes random v4 uuid as part of the resource name to be unguessable.<br /><br />
						<a href="https://documentation.onesignal.com/reference/csv-export#:~:text=On%20average%2C%20the,to%20be%20unguessable.">(Read More at Onsignal Documentation)</a>
					</p>
					<br />
					<b>Download Link</b> (If download doesn't work, please keep this link with you, onesignal will take some time to generate the file)
					<input type="text" id="csv_file_url" value="" style="width: 100%" />
				</div>
				<button id="downloadBtn" class="btn btn-success">Download CSV</button>
			</div>
		</div>

		<!-- Add Bootstrap 4 -->
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
		<script>
			document.addEventListener("DOMContentLoaded", function () {
				// Check if download link is in local storage
				if (localStorage.getItem("csv_file_url")) {
					document.getElementById("csv_file_url").value = localStorage.getItem("csv_file_url");
					document.getElementById("credentialsForm").style.display = "none";
					document.getElementById("downloadBtnDiv").style.display = "block";
					document.getElementById("message").textContent = "You already have a file to download.";
				}

				document.getElementById("credentialsForm").addEventListener("submit", function (e) {
					e.preventDefault();
					const appId = document.getElementById("appId").value;
					const apiKey = document.getElementById("apiKey").value;

					fetch("https://onesignal.com/api/v1/players/csv_export?app_id=" + appId, {
						method: "POST",
						headers: {
							Authorization: "Bearer " + apiKey,
							"Content-Type": "application/json",
						},
						body: JSON.stringify({ extra_fields: ["web_auth", "web_p256"] }),
					})
						.then((response) => response.json())
						.then((data) => {
							if (data.csv_file_url) {
								localStorage.setItem("csv_file_url", data.csv_file_url);
								document.getElementById("csv_file_url").value = data.csv_file_url;
								document.getElementById("message").textContent = "Please check back after some time for your download link.";
								document.getElementById("credentialsForm").style.display = "none";
								document.getElementById("downloadBtnDiv").style.display = "block";
							} else {
								document.getElementById("message").textContent = "Error: Please try again later.";
							}
						})
						.catch((error) => {
							console.error("Error:", error);
							document.getElementById("message").textContent = "Error: Please try again later.";
						});
				});

				document.getElementById("downloadBtn").addEventListener("click", function () {
					const downloadUrl = localStorage.getItem("csv_file_url");
					window.location.href = downloadUrl;
				});
			});
		</script>
	</body>
</html>
